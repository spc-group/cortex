import "@testing-library/jest-dom/vitest";
import type { ReactElement } from "react";
import { render, cleanup } from "@testing-library/react";
import { QueryClient, QueryClientProvider } from "@tanstack/react-query";
import { BrowserRouter } from "react-router";
import { vi, describe, it, expect, beforeEach, afterEach } from "vitest";
import { tableFromArrays } from "apache-arrow";

import { updateTableData, useDataTable } from "./use_data_table.ts";

const oldTable = tableFromArrays({
  x: [1, 2, 3],
  y: [5, 10, 20],
});

const nextRow = tableFromArrays({
  x: [4],
  y: [30],
});

describe("table reducer", () => {
  it("returns original table by default", () => {
    const newTable = updateTableData(oldTable, {
      type: "something-else",
      sequence: 10,
      timestamp: "2026-01-14T16:52:42.336523",
      mimetype: "application/vnd.apache.arrow.file",
      partition: 0,
      append: true,
      payload: nextRow,
    });
    expect(newTable).toBe(oldTable);
  });
  it("appends next row", () => {
    const newTable = updateTableData(oldTable, {
      type: "table-data",
      sequence: 10,
      timestamp: "2026-01-14T16:52:42.336523",
      mimetype: "application/vnd.apache.arrow.file",
      partition: 0,
      append: true,
      payload: nextRow,
    });
    expect(newTable).not.toBe(oldTable);
    expect(newTable?.getChild("x")?.toArray()).toEqual(
      new Float64Array([1, 2, 3, 4]),
    );
    expect(newTable?.getChild("y")?.toArray()).toEqual(
      new Float64Array([5, 10, 20, 30]),
    );
  });
  it("replaces the old table", () => {
    const updatedTable = tableFromArrays({
      x: [4, 5, 6],
      y: [30, 40, 60],
    });

    const newTable = updateTableData(oldTable, {
      type: "table-data",
      sequence: 10,
      timestamp: "2026-01-14T16:52:42.336523",
      mimetype: "application/vnd.apache.arrow.file",
      partition: 0,
      append: false,
      payload: updatedTable,
    });
    expect(newTable).toBe(updatedTable);
  });
});

describe("useDataTable() hook", () => {
  const doRender = async (elem: ReactElement) => {
    const queryClient = new QueryClient();
    return await render(
      <BrowserRouter>
        <QueryClientProvider client={queryClient}>{elem}</QueryClientProvider>
      </BrowserRouter>,
    );
  };
  const TableComponent = () => {
    const stream = {
      ancestors: [],
      data_keys: {},
      configuration: {},
      structure_family: "",
      specs: [],
      hints: {},
      time: 0,
      uid: "",
      key: "",
    };
    const { table } = useDataTable(stream);
    return (
      <div>
        {table?.toArray().map((row) => (
          <div key={row.x}>x = {row.x}</div>
        ))}
      </div>
    );
  };
  beforeEach(() => {
    vi.mock("@tanstack/react-query", async (importOriginal) => {
      return {
        ...(await importOriginal()),
        useQuery: () => ({
          data: tableFromArrays({
            x: [1, 2, 3],
          }),
          isLoading: false,
        }),
      };
    });
    vi.mock("./streaming", async () => {
      return {
        useTiledWebSocket: () => ({
          payload: {
            type: "table-data",
            sequence: 2,
            payload: nextRow,
            append: true,
          },
          readyState: 1,
        }),
      };
    });
  });
  afterEach(() => {
    vi.restoreAllMocks();
    cleanup();
  });
  it("returns combined tables", async () => {
    const { getByText } = await doRender(<TableComponent />);
    // This one comes from the HTTP request
    expect(getByText("x = 1")).toBeInTheDocument();
    // This one comes from websockets
    expect(getByText("x = 4")).toBeInTheDocument();
  });
});

// // A message taken from a tiled websocket connection
// const wsMessage = {
//   type: "table-data",
//   sequence: 10,
//   timestamp: "2026-01-14T16:52:42.336523",
//   mimetype: "application/vnd.apache.arrow.file",
//   partition: 0,
//   append: true,
//   payload: [
//     65, 82, 82, 79, 87, 49, 0, 0, 255, 255, 255, 255, 152, 2, 0, 0, 16, 0, 0, 0,
//     0, 0, 10, 0, 12, 0, 6, 0, 5, 0, 8, 0, 10, 0, 0, 0, 0, 1, 4, 0, 12, 0, 0, 0,
//     8, 0, 8, 0, 0, 0, 4, 0, 8, 0, 0, 0, 4, 0, 0, 0, 10, 0, 0, 0, 44, 2, 0, 0,
//     232, 1, 0, 0, 168, 1, 0, 0, 104, 1, 0, 0, 40, 1, 0, 0, 248, 0, 0, 0, 184, 0,
//     0, 0, 120, 0, 0, 0, 56, 0, 0, 0, 4, 0, 0, 0, 12, 254, 255, 255, 0, 0, 1, 3,
//     16, 0, 0, 0, 28, 0, 0, 0, 4, 0, 0, 0, 0, 0, 0, 0, 10, 0, 0, 0, 116, 115, 95,
//     115, 116, 97, 103, 101, 45, 120, 0, 0, 66, 254, 255, 255, 0, 0, 2, 0, 60,
//     254, 255, 255, 0, 0, 1, 3, 16, 0, 0, 0, 40, 0, 0, 0, 4, 0, 0, 0, 0, 0, 0, 0,
//     22, 0, 0, 0, 116, 115, 95, 100, 101, 116, 45, 99, 104, 97, 110, 110, 101,
//     108, 45, 51, 45, 118, 97, 108, 117, 101, 0, 0, 126, 254, 255, 255, 0, 0, 2,
//     0, 120, 254, 255, 255, 0, 0, 1, 3, 16, 0, 0, 0, 40, 0, 0, 0, 4, 0, 0, 0, 0,
//     0, 0, 0, 22, 0, 0, 0, 116, 115, 95, 100, 101, 116, 45, 99, 104, 97, 110,
//     110, 101, 108, 45, 50, 45, 118, 97, 108, 117, 101, 0, 0, 186, 254, 255, 255,
//     0, 0, 2, 0, 180, 254, 255, 255, 0, 0, 1, 3, 16, 0, 0, 0, 40, 0, 0, 0, 4, 0,
//     0, 0, 0, 0, 0, 0, 22, 0, 0, 0, 116, 115, 95, 100, 101, 116, 45, 99, 104, 97,
//     110, 110, 101, 108, 45, 49, 45, 118, 97, 108, 117, 101, 0, 0, 246, 254, 255,
//     255, 0, 0, 2, 0, 240, 254, 255, 255, 0, 0, 1, 3, 16, 0, 0, 0, 24, 0, 0, 0,
//     4, 0, 0, 0, 0, 0, 0, 0, 7, 0, 0, 0, 115, 116, 97, 103, 101, 45, 120, 0, 34,
//     255, 255, 255, 0, 0, 2, 0, 28, 255, 255, 255, 0, 0, 1, 2, 16, 0, 0, 0, 36,
//     0, 0, 0, 4, 0, 0, 0, 0, 0, 0, 0, 19, 0, 0, 0, 100, 101, 116, 45, 99, 104,
//     97, 110, 110, 101, 108, 45, 51, 45, 118, 97, 108, 117, 101, 0, 24, 255, 255,
//     255, 0, 0, 0, 1, 64, 0, 0, 0, 88, 255, 255, 255, 0, 0, 1, 2, 16, 0, 0, 0,
//     36, 0, 0, 0, 4, 0, 0, 0, 0, 0, 0, 0, 19, 0, 0, 0, 100, 101, 116, 45, 99,
//     104, 97, 110, 110, 101, 108, 45, 50, 45, 118, 97, 108, 117, 101, 0, 84, 255,
//     255, 255, 0, 0, 0, 1, 64, 0, 0, 0, 148, 255, 255, 255, 0, 0, 1, 2, 16, 0, 0,
//     0, 36, 0, 0, 0, 4, 0, 0, 0, 0, 0, 0, 0, 19, 0, 0, 0, 100, 101, 116, 45, 99,
//     104, 97, 110, 110, 101, 108, 45, 49, 45, 118, 97, 108, 117, 101, 0, 144,
//     255, 255, 255, 0, 0, 0, 1, 64, 0, 0, 0, 208, 255, 255, 255, 0, 0, 1, 3, 16,
//     0, 0, 0, 28, 0, 0, 0, 4, 0, 0, 0, 0, 0, 0, 0, 4, 0, 0, 0, 116, 105, 109,
//     101, 0, 0, 6, 0, 8, 0, 6, 0, 6, 0, 0, 0, 0, 0, 2, 0, 16, 0, 20, 0, 8, 0, 6,
//     0, 7, 0, 12, 0, 0, 0, 16, 0, 16, 0, 0, 0, 0, 0, 1, 2, 16, 0, 0, 0, 32, 0, 0,
//     0, 4, 0, 0, 0, 0, 0, 0, 0, 7, 0, 0, 0, 115, 101, 113, 95, 110, 117, 109, 0,
//     8, 0, 12, 0, 8, 0, 7, 0, 8, 0, 0, 0, 0, 0, 0, 1, 64, 0, 0, 0, 0, 0, 0, 0,
//     255, 255, 255, 255, 56, 2, 0, 0, 20, 0, 0, 0, 0, 0, 0, 0, 12, 0, 22, 0, 6,
//     0, 5, 0, 8, 0, 12, 0, 12, 0, 0, 0, 0, 3, 4, 0, 24, 0, 0, 0, 80, 0, 0, 0, 0,
//     0, 0, 0, 0, 0, 10, 0, 24, 0, 12, 0, 4, 0, 8, 0, 10, 0, 0, 0, 92, 1, 0, 0,
//     16, 0, 0, 0, 1, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 20, 0, 0, 0, 0, 0, 0, 0, 0,
//     0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 8, 0, 0, 0, 0, 0,
//     0, 0, 8, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 8, 0, 0, 0, 0, 0, 0,
//     0, 8, 0, 0, 0, 0, 0, 0, 0, 16, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0,
//     16, 0, 0, 0, 0, 0, 0, 0, 8, 0, 0, 0, 0, 0, 0, 0, 24, 0, 0, 0, 0, 0, 0, 0, 0,
//     0, 0, 0, 0, 0, 0, 0, 24, 0, 0, 0, 0, 0, 0, 0, 8, 0, 0, 0, 0, 0, 0, 0, 32, 0,
//     0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 32, 0, 0, 0, 0, 0, 0, 0, 8, 0, 0,
//     0, 0, 0, 0, 0, 40, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 40, 0, 0, 0,
//     0, 0, 0, 0, 8, 0, 0, 0, 0, 0, 0, 0, 48, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0,
//     0, 0, 0, 48, 0, 0, 0, 0, 0, 0, 0, 8, 0, 0, 0, 0, 0, 0, 0, 56, 0, 0, 0, 0, 0,
//     0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 56, 0, 0, 0, 0, 0, 0, 0, 8, 0, 0, 0, 0, 0, 0,
//     0, 64, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 64, 0, 0, 0, 0, 0, 0, 0,
//     8, 0, 0, 0, 0, 0, 0, 0, 72, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 72,
//     0, 0, 0, 0, 0, 0, 0, 8, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 10, 0, 0, 0, 1, 0,
//     0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 1, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0,
//     0, 0, 0, 0, 0, 1, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 1, 0, 0, 0,
//     0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 1, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0,
//     0, 0, 0, 1, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 1, 0, 0, 0, 0, 0,
//     0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 1, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0,
//     0, 1, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 1, 0, 0, 0, 0, 0, 0, 0,
//     0, 0, 0, 0, 0, 0, 0, 0, 10, 0, 0, 0, 0, 0, 0, 0, 11, 147, 148, 142, 7, 90,
//     218, 65, 5, 1, 0, 0, 0, 0, 0, 0, 37, 1, 0, 0, 0, 0, 0, 0, 33, 1, 0, 0, 0, 0,
//     0, 0, 154, 153, 153, 153, 153, 153, 25, 192, 106, 129, 148, 142, 7, 90, 218,
//     65, 230, 129, 148, 142, 7, 90, 218, 65, 12, 130, 148, 142, 7, 90, 218, 65,
//     195, 7, 142, 142, 7, 90, 218, 65, 255, 255, 255, 255, 0, 0, 0, 0, 16, 0, 0,
//     0, 12, 0, 20, 0, 6, 0, 8, 0, 12, 0, 16, 0, 12, 0, 0, 0, 0, 0, 4, 0, 56, 0,
//     0, 0, 40, 0, 0, 0, 4, 0, 0, 0, 1, 0, 0, 0, 168, 2, 0, 0, 0, 0, 0, 0, 64, 2,
//     0, 0, 0, 0, 0, 0, 80, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 8, 0, 8,
//     0, 0, 0, 4, 0, 8, 0, 0, 0, 4, 0, 0, 0, 10, 0, 0, 0, 44, 2, 0, 0, 232, 1, 0,
//     0, 168, 1, 0, 0, 104, 1, 0, 0, 40, 1, 0, 0, 248, 0, 0, 0, 184, 0, 0, 0, 120,
//     0, 0, 0, 56, 0, 0, 0, 4, 0, 0, 0, 12, 254, 255, 255, 0, 0, 1, 3, 16, 0, 0,
//     0, 28, 0, 0, 0, 4, 0, 0, 0, 0, 0, 0, 0, 10, 0, 0, 0, 116, 115, 95, 115, 116,
//     97, 103, 101, 45, 120, 0, 0, 66, 254, 255, 255, 0, 0, 2, 0, 60, 254, 255,
//     255, 0, 0, 1, 3, 16, 0, 0, 0, 40, 0, 0, 0, 4, 0, 0, 0, 0, 0, 0, 0, 22, 0, 0,
//     0, 116, 115, 95, 100, 101, 116, 45, 99, 104, 97, 110, 110, 101, 108, 45, 51,
//     45, 118, 97, 108, 117, 101, 0, 0, 126, 254, 255, 255, 0, 0, 2, 0, 120, 254,
//     255, 255, 0, 0, 1, 3, 16, 0, 0, 0, 40, 0, 0, 0, 4, 0, 0, 0, 0, 0, 0, 0, 22,
//     0, 0, 0, 116, 115, 95, 100, 101, 116, 45, 99, 104, 97, 110, 110, 101, 108,
//     45, 50, 45, 118, 97, 108, 117, 101, 0, 0, 186, 254, 255, 255, 0, 0, 2, 0,
//     180, 254, 255, 255, 0, 0, 1, 3, 16, 0, 0, 0, 40, 0, 0, 0, 4, 0, 0, 0, 0, 0,
//     0, 0, 22, 0, 0, 0, 116, 115, 95, 100, 101, 116, 45, 99, 104, 97, 110, 110,
//     101, 108, 45, 49, 45, 118, 97, 108, 117, 101, 0, 0, 246, 254, 255, 255, 0,
//     0, 2, 0, 240, 254, 255, 255, 0, 0, 1, 3, 16, 0, 0, 0, 24, 0, 0, 0, 4, 0, 0,
//     0, 0, 0, 0, 0, 7, 0, 0, 0, 115, 116, 97, 103, 101, 45, 120, 0, 34, 255, 255,
//     255, 0, 0, 2, 0, 28, 255, 255, 255, 0, 0, 1, 2, 16, 0, 0, 0, 36, 0, 0, 0, 4,
//     0, 0, 0, 0, 0, 0, 0, 19, 0, 0, 0, 100, 101, 116, 45, 99, 104, 97, 110, 110,
//     101, 108, 45, 51, 45, 118, 97, 108, 117, 101, 0, 24, 255, 255, 255, 0, 0, 0,
//     1, 64, 0, 0, 0, 88, 255, 255, 255, 0, 0, 1, 2, 16, 0, 0, 0, 36, 0, 0, 0, 4,
//     0, 0, 0, 0, 0, 0, 0, 19, 0, 0, 0, 100, 101, 116, 45, 99, 104, 97, 110, 110,
//     101, 108, 45, 50, 45, 118, 97, 108, 117, 101, 0, 84, 255, 255, 255, 0, 0, 0,
//     1, 64, 0, 0, 0, 148, 255, 255, 255, 0, 0, 1, 2, 16, 0, 0, 0, 36, 0, 0, 0, 4,
//     0, 0, 0, 0, 0, 0, 0, 19, 0, 0, 0, 100, 101, 116, 45, 99, 104, 97, 110, 110,
//     101, 108, 45, 49, 45, 118, 97, 108, 117, 101, 0, 144, 255, 255, 255, 0, 0,
//     0, 1, 64, 0, 0, 0, 208, 255, 255, 255, 0, 0, 1, 3, 16, 0, 0, 0, 28, 0, 0, 0,
//     4, 0, 0, 0, 0, 0, 0, 0, 4, 0, 0, 0, 116, 105, 109, 101, 0, 0, 6, 0, 8, 0, 6,
//     0, 6, 0, 0, 0, 0, 0, 2, 0, 16, 0, 20, 0, 8, 0, 6, 0, 7, 0, 12, 0, 0, 0, 16,
//     0, 16, 0, 0, 0, 0, 0, 1, 2, 16, 0, 0, 0, 32, 0, 0, 0, 4, 0, 0, 0, 0, 0, 0,
//     0, 7, 0, 0, 0, 115, 101, 113, 95, 110, 117, 109, 0, 8, 0, 12, 0, 8, 0, 7, 0,
//     8, 0, 0, 0, 0, 0, 0, 1, 64, 0, 0, 0, 192, 2, 0, 0, 65, 82, 82, 79, 87, 49,
//   ],
// };
